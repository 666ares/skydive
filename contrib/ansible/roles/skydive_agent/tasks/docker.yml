---
- name: Install Docker
  package:
    name: docker
    state: present

- name: Enable Docker service
  service:
    name: docker
    state: started
    enabled: yes

- name: Run docker registry
  shell: "docker run -d -p 5000:5000 --restart=always --name registry registry:2"
  when: '"file://" in skydive_binary_remote_location'

- name: Set facts
  set_fact: "skydive_docker_registry=localhost:5000"
  when: '"file://" in skydive_binary_remote_location'

- name: Copy docker image
  copy:
    src: "{{ skydive_binary_remote_location | replace('file://', '') }}"
    dest: /tmp
    force: true
    mode: 0755
  when: '"file://" in skydive_binary_remote_location'

- name: Import skydive image
  shell: "docker load -i /tmp/{{ skydive_binary_remote_location | replace('file://', '') | basename }}"
  when: '"file://" in skydive_binary_remote_location'

- name: Tag skydive image
  shell: "docker tag skydive/skydive:devel {{ skydive_docker_registry }}/{{ skydive_agent_docker_image }}:{{ skydive_docker_image_tag }}"
  when: '"file://" in skydive_binary_remote_location'

- name: Push skydive image to registry
  shell: "docker push {{ skydive_docker_registry }}/{{ skydive_agent_docker_image }}:{{ skydive_docker_image_tag }}"
  when: '"file://" in skydive_binary_remote_location'

- name: Create systemd unit file
  include_role:
    name: skydive_common
    tasks_from: systemd
  vars:
    service_name: skydive-agent
    exec_start_pre: /usr/bin/docker stop skydive-agent-{{ ansible_hostname }}
    exec_start: |
      /usr/bin/docker run --rm \
        --privileged --net=host --pid=host \
        -v /var/run/openvswitch/db.sock:/var/run/openvswitch/db.sock \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v /var/run/netns:/host/run:ro,shared \
        -v /etc/skydive/skydive.yml:/etc/skydive.yml \
        -e SKYDIVE_NETNS_RUN_PATH=/host/run {{ skydive_agent_docker_extra_env }} \
        -p {{ skydive_agent_port }}:{{ skydive_agent_port }} \
        --name=skydive-agent-{{ ansible_hostname }} \
        {{ skydive_docker_registry }}/{{ skydive_agent_docker_image }}:{{ skydive_docker_image_tag }} \
        {{ skydive_agent_docker_command }}
    exec_stop_post: /usr/bin/docker stop skydive-agent-{{ ansible_hostname }}
